name: Update ModelScope Documentation

on:
  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©UTCæ—¶é—´2:00ï¼Œå³åŒ—äº¬æ—¶é—´10:00ï¼‰
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨GitHubç½‘é¡µç‚¹å‡»è¿è¡Œï¼‰
  workflow_dispatch:
  
  # å½“model_list.txtæˆ–å·¥ä½œæµæ–‡ä»¶å˜æ›´æ—¶è§¦å‘
  push:
    paths:
      - 'docs/flagrelease_en/model_list.txt'
      - '.github/workflows/update-modelscope-docs.yml'
      - 'docs/scripts/download_readmes.py'

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›ï¸ æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        # ç¼“å­˜ä¾èµ–ï¼Œæé«˜åç»­è¿è¡Œé€Ÿåº¦
        cache-dependency-path: 'docs/scripts/requirements.txt'
    
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        # åœ¨æ ¹ç›®å½•ä¸‹å®‰è£…ä¾èµ–ï¼Œä½†æŒ‡å®šrequirements.txtè·¯å¾„
        pip install -r docs/scripts/requirements.txt
    
    - name: ğŸ“¥ ä¸‹è½½ModelScopeæ–‡æ¡£
      id: download
      run: |
        # å…³é”®ä¿®å¤ï¼šåœ¨ä»“åº“æ ¹ç›®å½•æ‰§è¡Œè„šæœ¬ï¼Œå¹¶ä¼ é€’æ­£ç¡®çš„è·¯å¾„
        cd /home/runner/work/test-github-actions/test-github-actions
        python docs/scripts/download_readmes.py
      continue-on-error: true
    
    - name: ğŸ“Š æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: check-changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹æˆ–æ–°å¢
        git add -N .
        if git diff --name-only --exit-code docs/flagrelease_en/model_readmes/; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ”„ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´:"
          git diff --name-only docs/flagrelease_en/model_readmes/
        fi
    
    - name: ğŸ’¾ æäº¤å¹¶æ¨é€æ›´æ”¹
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # é…ç½®Gitç”¨æˆ·
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ·»åŠ å˜æ›´æ–‡ä»¶ï¼ˆåªæ·»åŠ flagrelease_enç›®å½•ä¸‹çš„ï¼‰
        git add docs/flagrelease_en/model_readmes/
        
        # æäº¤æ›´æ”¹
        git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°ModelScopeæ–‡æ¡£ [$(date +'%Y-%m-%d %H:%M')]"
        
        # æ¨é€åˆ°ä»“åº“
        git push origin HEAD:${{ github.ref_name }}
        echo "âœ… æ›´æ”¹å·²æ¨é€åˆ°ä»“åº“"
    
    - name: ğŸ“‹ ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
      if: always()
      run: |
        echo "å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€: ${{ job.status }}"
        echo "æ˜¯å¦æ£€æµ‹åˆ°å˜æ›´: ${{ steps.check-changes.outputs.has_changes }}"
        echo "æ‰§è¡Œå®Œæˆæ—¶é—´: $(date)"